name: Helm Chart Lint

on:
  pull_request:
  push:
    branches:
      - main
      - develop

permissions:
  contents: read

jobs:
  helm-lint:
    runs-on: ubuntu-latest
    env:
      KUBECONFORM_VERSION: 0.6.7
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          set -euo pipefail
          curl -L -o /tmp/kubeconform.tar.gz \
            "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          curl -L -o /tmp/kubeconform_checksums.txt \
            "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/CHECKSUMS"
          grep "kubeconform-linux-amd64.tar.gz" /tmp/kubeconform_checksums.txt \
            | awk '{print $1 "  /tmp/kubeconform.tar.gz"}' \
            | sha256sum -c -
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp
          sudo mv /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Show kubeconform version
        run: |
          echo "kubeconform version (pinned): ${KUBECONFORM_VERSION}"
          kubeconform -v || kubeconform --version || true

      - name: Run Helm Validation
        run: |
          bash scripts/ci/helm_render_validate.sh

      - name: Check for legacy patterns
        run: |
          bash scripts/ci/check_container_paths.sh
