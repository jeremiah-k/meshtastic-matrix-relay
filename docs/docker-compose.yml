services:
  mmrelay:
    # Replace REPLACE_ME with a published image tag before running
    image: ghcr.io/jeremiah-k/mmrelay:REPLACE_ME
    container_name: mmrelay
    restart: unless-stopped

    environment:
      - MMRELAY_HOME=/data
      - MMRELAY_READY_FILE=/tmp/mmrelay-ready
      - TZ=UTC

    volumes:
      # Persistent data directory (config, credentials, database, logs, plugins, E2EE store)
      - ./mmrelay-data:/data

    # Default command implicitly uses /data/config.yaml
    command:
      - mmrelay

    # Lightweight health check using the same ready-file concept as Helm.
    healthcheck:
      test: [CMD-SHELL, test -f /tmp/mmrelay-ready]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.1'
    #       memory: 128M

    # Optional: Read-only root filesystem (requires tmpfs for /tmp)
    # security_opt:
    #   - no-new-privileges:true
    # read_only: true
    # tmpfs:
    #   - /tmp:mode=1777
