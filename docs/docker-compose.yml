services:
  mmrelay:
    # Replace REPLACE_ME with a published image tag before running
    image: ghcr.io/jeremiah-k/mmrelay:REPLACE_ME
    container_name: mmrelay
    restart: unless-stopped

    environment:
      - MMRELAY_HOME=/data
      - TZ=UTC

    volumes:
      # Persistent data directory (credentials, database, logs, plugins, E2EE store)
      - ./mmrelay-data:/data

      # Configuration file (read-only, binds from current directory)
      - ./config.yaml:/app/config.yaml:ro

    # Command uses only --config; MMRELAY_HOME drives all other paths
    command:
      - mmrelay
      - --config
      - /app/config.yaml

    # Lightweight health check using the same ready-file concept as Helm.
    healthcheck:
      test: ["CMD-SHELL", "test -f /run/mmrelay/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.1'
    #       memory: 128M

    # Optional: Read-only root filesystem (requires tmpfs for /tmp)
    # security_opt:
    #   - no-new-privileges:true
    # read_only: true
    # tmpfs:
    #   - /tmp:mode=1777
