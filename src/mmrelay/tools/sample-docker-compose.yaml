services:
  mmrelay:
    build: .
    container_name: meshtastic-matrix-relay
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"

    environment:
      - TZ=UTC
      - PYTHONUNBUFFERED=1
      - MPLCONFIGDIR=/tmp/matplotlib

      # Matrix Authentication (E2EE Support) - Uncomment and configure as needed
      # Method 1: Individual environment variables (recommended)
      # - MATRIX_HOMESERVER=https://matrix.example.org
      # - MATRIX_ACCESS_TOKEN=syt_your_access_token_here
      # - MATRIX_BOT_USER_ID=@yourbot:example.org
      # - MATRIX_DEVICE_ID=ABCDEFGHIJ  # Optional but recommended for E2EE

      # Method 2: Base64 encoded credentials.json (alternative)
      # - MATRIX_CREDENTIALS_JSON=eyJob21lc2VydmVyIjoi...

      # Note: Environment variables take precedence over credentials.json and config.yaml

    volumes:
      # Configuration - uses standard ~/.mmrelay/config.yaml location
      # Create this first with: make config
      - ${MMRELAY_HOME}/.mmrelay/config.yaml:/app/config.yaml:ro

      # Map entire ~/.mmrelay directory to /app/data to maintain proper structure
      # This includes plugins/, data/, logs/, and any other subdirectories
      # The --data-dir parameter in CMD points to /app/data
      - ${MMRELAY_HOME}/.mmrelay:/app/data

    # For TCP connections (most common) - Meshtastic typically uses port 4403
    ports:
      - 4403:4403

    # For serial connections, uncomment the device you need:
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    #   - /dev/ttyACM0:/dev/ttyACM0

    # For BLE connections, uncomment these:
    # privileged: true
    # network_mode: host
    # Additional volumes for BLE (add to existing volumes section above):
    #   - /var/run/dbus:/var/run/dbus:ro
    #   - /sys/bus/usb:/sys/bus/usb:ro
    #   - /sys/class/bluetooth:/sys/class/bluetooth:ro
    #   - /sys/devices:/sys/devices:ro
